<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Course Details - Handbook</title>
<style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; background-color: #f4f7f6; }
    .navbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; background: white; padding: 10px 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .nav-links a { margin-left: 15px; text-decoration: none; color: #007bff; font-weight: 500; }
    h1 { color: #333; margin: 0; }
    .course-detail { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .course-header { display: flex; gap: 25px; margin-bottom: 30px; }
    .course-photo { width: 250px; height: 250px; object-fit: cover; border-radius: 8px; background-color: #eee; }
    .course-info h2 { margin-top: 0; color: #007bff; }
    .level-badge { background: #e9ecef; padding: 6px 12px; border-radius: 15px; font-size: 0.9em; color: #495057; font-weight: 600; display: inline-block; margin-bottom: 15px; }
    .section { margin-bottom: 25px; }
    .section h3 { border-bottom: 2px solid #eee; padding-bottom: 8px; color: #333; }
    .section p { line-height: 1.6; color: #555; white-space: pre-wrap; }
    .back-btn { display: inline-block; margin-bottom: 20px; text-decoration: none; color: #666; font-weight: bold; }
</style>
</head>
<body>

<div class="navbar">
    <h1>Handbook</h1>
    <div class="nav-links">
        <a href="index.html">Home</a>
    </div>
</div>

<a href="index.html" class="back-btn">‚Üê Back to List</a>

<div id="courseContent" class="course-detail">
    <p>Loading data...</p>
</div>

<script>
    async function loadCourseDetail() {
        const urlParams = new URLSearchParams(window.location.search);
        const courseId = urlParams.get('id');

        if (!courseId) {
            document.getElementById('courseContent').innerHTML = '<p>Course ID not specified</p>';
            return;
        }

        try {
            const res = await fetch(`/api/course?id=${courseId}`);
            if (!res.ok) throw new Error('Course not found');
            const course = await res.json();

            const photoHtml = course.photo_url ? `<img src="${course.photo_url}" class="course-photo" alt="${course.title}">` : '<div class="course-photo" style="display:flex;align-items:center;justify-content:center;color:#999">No Photo</div>';

            document.getElementById('courseContent').innerHTML = `
                <div class="course-header">
                    ${photoHtml}
                    <div class="course-info">
                        <h2>${course.title}</h2>
                        <span class="level-badge">Level: ${course.level || 'Not specified'}</span>
                        <p><strong>Author:</strong> ${course.author_name || 'Unknown'}</p>
                        
                        <div id="ratingArea" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px; display: inline-block;">
                            <div style="font-weight: bold; margin-bottom: 5px;">Rating: <span id="avgRating">${course.average_rating || 0}</span>/5 <span style="font-weight:normal; color:#666;">(${course.rating_count || 0} votes)</span></div>
                            <div id="userRatingStars" style="cursor: pointer; font-size: 24px;">
                                <!-- Stars generated by JS -->
                            </div>
                            <div id="rateMsg" style="font-size: 0.8em; color: green; height: 1.2em;"></div>
                        </div>

                        <div id="adminActions" style="margin-top: 20px; display: none;">
                            <button onclick="confirmDelete('${course.id || course._id}')" style="background:#dc3545; color:white; border:none; padding:8px 16px; border-radius:5px; cursor:pointer; font-weight:bold;">Delete Course</button>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h3>Description</h3>
                    <p>${course.description || 'No description available'}</p>
                </div>

                <div class="section">
                    <h3>General Information</h3>
                    <p>${course.general_info || 'No additional information'}</p>
                </div>

                <div class="section" id="curriculumSection">
                    <h3>Curriculum</h3>
                    <div id="enrollmentStatus" style="margin-bottom: 20px;">Checking status...</div>
                    <ul id="sectionList" style="list-style: none; padding: 0;"></ul>
                </div>
            `;
            
            checkEnrollment(course);
            initRating(course);
            checkAdmin(course);

        } catch (err) {
            document.getElementById('courseContent').innerHTML = `<p>Error: ${err.message}</p>`;
        }
    }

    async function checkAdmin(course) {
        const token = localStorage.getItem('token');
        if (!token) return;

        try {
            const res = await fetch('/api/profile', {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if (!res.ok) return;
            const data = await res.json();
            
            const isAdmin = data.user.role === 'admin';
            const isAuthor = data.user.id === course.author_id;

            if (isAdmin || isAuthor) {
                document.getElementById('adminActions').style.display = 'block';
            }
        } catch (e) {
            console.error("Error checking admin status", e);
        }
    }

    async function confirmDelete(courseId) {
        if (!confirm("Are you sure you want to delete this course? This action cannot be undone.")) {
            return;
        }

        const token = localStorage.getItem('token');
        try {
            const res = await fetch(`/api/course?id=${courseId}`, {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + token }
            });

            if (res.ok) {
                alert("Course deleted successfully.");
                window.location.href = "index.html";
            } else {
                const errData = await res.json();
                alert("Error: " + (errData.message || "Could not delete course"));
            }
        } catch (e) {
            alert("Network error occurred.");
        }
    }

    async function initRating(course) {
        const token = localStorage.getItem('token');
        const starContainer = document.getElementById('userRatingStars');
        
        // 1. Render blank/interactive stars
        renderUserStars(0);

        if (!token) {
            document.getElementById('rateMsg').innerText = "Login to rate";
            return;
        }

        // 2. Fetch user's existing rating
        try {
            const res = await fetch(`/api/user_rating?course_id=${course.id || course._id}`, {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            const data = await res.json();
            if (data.score > 0) {
                renderUserStars(data.score);
                document.getElementById('rateMsg').innerText = "You rated: " + data.score;
            }
        } catch (e) {
            console.error("Error fetching rating", e);
        }

        // 3. Add click handlers
        starContainer.onmouseleave = () => {
             // Reset to saved state logic could go here, simplified for now
        };
    }

    function renderUserStars(currentScore) {
        const container = document.getElementById('userRatingStars');
        let html = '';
        for (let i = 1; i <= 5; i++) {
            const color = i <= currentScore ? '#ffc107' : '#e4e5e9';
            html += `<span onclick="submitRating(${i})" onmouseover="highlightStars(this, ${i})" style="color: ${color}; transition: color 0.2s;">‚òÖ</span>`;
        }
        container.innerHTML = html;
    }

    function highlightStars(span, score) {
        // Optional: visual feedback on hover
        // For simplicity, we stick to click updates
    }

    async function submitRating(score) {
        const token = localStorage.getItem('token');
        if (!token) {
            alert("Please login to rate.");
            return;
        }

        document.getElementById('rateMsg').innerText = "Saving...";
        
        try {
            const res = await fetch('/api/rate', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({ 
                    course_id: getCourseId(),
                    score: score 
                })
            });

            if (res.ok) {
                const data = await res.json();
                renderUserStars(score);
                document.getElementById('rateMsg').innerText = "Saved!";
                
                // Update average display
                document.getElementById('avgRating').innerText = data.average_rating;
                // Update count text slightly complex with regex or reload, simple reload of text:
                const countSpan = document.getElementById('avgRating').nextElementSibling;
                countSpan.innerText = `(${data.rating_count} votes)`;
            } else {
                alert("Error saving rating");
            }
        } catch (e) {
            console.error(e);
        }
    }

    async function checkEnrollment(course) {
        const token = localStorage.getItem('token');
        const statusDiv = document.getElementById('enrollmentStatus');
        const listDiv = document.getElementById('sectionList');

        if (!token) {
            statusDiv.innerHTML = '<p>Please <a href="login.html">login</a> to enroll.</p>';
            renderSections(course.sections || [], [], false);
            return;
        }

        const res = await fetch(`/api/progress?course_id=${course.id || course._id}`, {
            headers: { 'Authorization': 'Bearer ' + token }
        });
        
        const data = await res.json();
        
        if (!data.started) {
            statusDiv.innerHTML = `<button onclick="enroll('${course.id || course._id}')" style="background:#007bff; color:white; border:none; padding:10px 20px; border-radius:5px; font-size:16px; cursor:pointer;">Start Learning</button>`;
            renderSections(course.sections || [], [], false);
        } else {
            let progressText = data.is_finished ? 
                '<span style="color:green; font-weight:bold;">Course Completed! üéâ</span>' : 
                `<span style="color:#666;">Progress: ${data.completed_section_ids.length} / ${course.sections ? course.sections.length : 0} steps</span>`;
            
            if (data.is_finished) {
                progressText += `
                    <div style="margin-top:10px;">
                        <button onclick="downloadCertificate('${course.id || course._id}')" style="background:#28a745; color:white; border:none; padding:8px 16px; border-radius:5px; cursor:pointer; font-weight:bold;">Download Certificate (PDF)</button>
                    </div>
                `;
            }

            statusDiv.innerHTML = progressText;
            renderSections(course.sections || [], data.completed_section_ids, true);
        }
    }

    async function downloadCertificate(courseId) {
        const token = localStorage.getItem('token');
        try {
            const res = await fetch(`/api/certificate?course_id=${courseId}`, {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if (!res.ok) {
                alert("Failed to download certificate. Make sure you finished the course.");
                return;
            }
            const blobData = await res.blob();
            const url = window.URL.createObjectURL(blobData);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Certificate.pdf`;
            document.body.appendChild(a);
            a.click();
            a.remove();
        } catch (e) {
            console.error(e);
            alert("Error downloading certificate");
        }
    }

    async function enroll(courseId) {
        const token = localStorage.getItem('token');
        await fetch('/api/enroll', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({ course_id: courseId })
        });
        location.reload();
    }

    function renderSections(sections, completedIds, isEnrolled) {
        const list = document.getElementById('sectionList');
        if (!sections || sections.length === 0) {
            list.innerHTML = '<li>No sections added yet.</li>';
            return;
        }

        // Sort by order just in case
        sections.sort((a, b) => a.order - b.order);

        let html = '';
        let previousCompleted = true; // First item is unlocked by default if enrolled

        sections.forEach((s, index) => {
            const isCompleted = completedIds.includes(s.id);
            const isLocked = !isEnrolled || (!isCompleted && !previousCompleted);
            
            // Logic: You can access if it's completed OR if it's the immediate next one (previous one was completed)
            // But wait, "Step by Step" usually means you can access current if previous is done.
            const canAccess = isEnrolled && (isCompleted || previousCompleted);

            let statusIcon = 'üîí';
            let action = '<span style="color:#999; font-size:0.9em;">Locked</span>';
            let rowStyle = 'background: #f8f9fa; color: #999;';

            if (isCompleted) {
                statusIcon = '‚úÖ';
                action = `<a href="section.html?course_id=${getCourseId()}&section_id=${s.id}" style="color:green; font-weight:bold;">Review</a>`;
                rowStyle = 'background: #e8f5e9; border-left: 4px solid green;';
            } else if (canAccess) {
                statusIcon = '‚ñ∂Ô∏è';
                action = `<a href="section.html?course_id=${getCourseId()}&section_id=${s.id}" style="color:#007bff; font-weight:bold;">Start</a>`;
                rowStyle = 'background: white; border-left: 4px solid #007bff; box-shadow: 0 2px 5px rgba(0,0,0,0.05);';
            }

            if (!isEnrolled) {
                 rowStyle = 'background: #f8f9fa; opacity: 0.7;';
                 statusIcon = 'üîí';
                 action = 'Enroll to start';
            }

            html += `
                <li style="padding: 15px; margin-bottom: 10px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; ${rowStyle}">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span>${statusIcon}</span>
                        <div>
                            <div style="font-weight:bold;">${index + 1}. ${s.title}</div>
                        </div>
                    </div>
                    <div>${action}</div>
                </li>
            `;

            if (!isCompleted) previousCompleted = false;
        });

        list.innerHTML = html;
    }
    
    function getCourseId() {
        return new URLSearchParams(window.location.search).get('id');
    }

    loadCourseDetail();
</script>
</body>
</html>
