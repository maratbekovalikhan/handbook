<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Profile - Handbook</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 600px; margin: 40px auto; padding: 20px; background-color: #f4f7f6; }
        .profile-card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h1 { margin-top: 0; color: #333; }
        .info-group { margin-bottom: 15px; font-size: 18px; }
        .info-label { font-weight: bold; color: #666; width: 100px; display: inline-block; }
        .btn-logout { background-color: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 20px; }
        .back-link { display: block; margin-top: 20px; color: #007bff; text-decoration: none; }
    </style>
</head>
<body>
<div class="profile-card">
    <h1>User Profile</h1>
    <div id="userInfo">
        <p>Loading...</p>
    </div>

    <div id="enrolledCourses" style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;">
        <h3>Learning in Progress</h3>
        <div id="enrolledList">Loading...</div>
    </div>

    <div id="userCourses" style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;">
        <h3>My Created Courses</h3>
        <div id="courseList">Loading courses...</div>
    </div>

    <button class="btn-logout" onclick="logout()">Logout</button>
    <a href="index.html" class="back-link">← Back to Home</a>
</div>

<script>
    async function loadProfile() {
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = 'login.html';
            return;
        }

        const res = await fetch('/api/profile', {
            headers: { 'Authorization': 'Bearer ' + token }
        });

        if (res.ok) {
            const data = await res.json();
            const user = data.user;
            const courses = data.courses; // Created courses
            const enrolled = data.enrolled_courses; // Enrolled courses

            document.getElementById('userInfo').innerHTML = `
                <div class="info-group"><span class="info-label">Name:</span> ${user.name}</div>
                <div class="info-group"><span class="info-label">Email:</span> ${user.email}</div>
            `;

            // Render Enrolled Courses
            const enrolledList = document.getElementById('enrolledList');
            if (enrolled && enrolled.length > 0) {
                 let html = '<ul style="list-style: none; padding: 0;">';
                 enrolled.forEach(item => {
                     const c = item.course;
                     const p = item.progress;
                     const courseId = (typeof c.id === 'object' && c.id !== null) ? (c.id.$oid || JSON.stringify(c.id)) : c.id;
                     
                     const total = c.sections ? c.sections.length : 0;
                     const done = p.completed_section_ids ? p.completed_section_ids.length : 0;
                     const percent = total > 0 ? Math.round((done / total) * 100) : 0;
                     const isCompleted = percent === 100 || p.is_finished;
                     
                     let liStyle = 'background: #e3f2fd; border: 1px solid #bbdefb;';
                     let titleColor = '#0d47a1';
                     let statusText = `${done}/${total} steps (${percent}%)`;
                     let statusColor = '#546e7a';
                     let barBg = '#bbdefb';
                     let barFill = '#1976d2';
                     let btnText = 'Continue Learning →';
                     let btnColor = '#1565c0';

                     if (isCompleted) {
                         liStyle = 'background: #d4edda; border: 1px solid #c3e6cb;';
                         titleColor = '#155724';
                         statusText = 'Completed ✅';
                         statusColor = '#155724';
                         barBg = '#c3e6cb';
                         barFill = '#28a745';
                         btnText = 'Review Course';
                         btnColor = '#155724';
                     }

                     html += `
                        <li style="${liStyle} padding: 15px; margin-bottom: 10px; border-radius: 8px;">
                            <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                                <strong style="color:${titleColor};">${c.title}</strong>
                                <span style="font-size:0.9em; color:${statusColor}; font-weight: ${isCompleted ? 'bold' : 'normal'}">${statusText}</span>
                            </div>
                            <div style="background:${barBg}; height:8px; border-radius:4px; overflow:hidden; margin-bottom: 10px;">
                                <div style="width:${percent}%; background:${barFill}; height:100%; transition: width 0.5s;"></div>
                            </div>
                            <div style="text-align:right;">
                                <a href="course_detail.html?id=${courseId}" style="text-decoration:none; color:${btnColor}; font-weight:600; font-size:0.95em;">${btnText}</a>
                            </div>
                        </li>
                     `;
                 });
                 html += '</ul>';
                 enrolledList.innerHTML = html;
            } else {
                 enrolledList.innerHTML = '<p style="color: #666; font-style: italic;">You are not enrolled in any courses yet.</p>';
            }

            // Render Created Courses
            const courseList = document.getElementById('courseList');
            if (courses && courses.length > 0) {
                let html = '<ul style="list-style: none; padding: 0;">';
                courses.forEach(c => {
                    const courseId = (typeof c.id === 'object' && c.id !== null) ? (c.id.$oid || JSON.stringify(c.id)) : c.id;
                    
                    html += `
                        <li style="background: #f8f9fa; padding: 10px; margin-bottom: 10px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 500;">${c.title}</span>
                            <div>
                                <a href="course_detail.html?id=${courseId}" style="text-decoration: none; color: #007bff; font-size: 0.9em; margin-right: 15px;">View</a>
                                <button onclick="deleteCourse('${courseId}')" style="background: none; border: none; color: #dc3545; cursor: pointer; font-size: 0.9em; font-weight: 500;">Delete</button>
                            </div>
                        </li>
                    `;
                });
                html += '</ul>';
                courseList.innerHTML = html;
            } else {
                courseList.innerHTML = '<p style="color: #666; font-style: italic;">You haven\'t created any courses yet.</p>';
            }

        } else {
            localStorage.removeItem('token');
            window.location.href = 'login.html';
        }
    }

    async function deleteCourse(id) {
        if (!confirm("Are you sure you want to delete this course? This action cannot be undone.")) return;

        const token = localStorage.getItem('token');
        try {
            const res = await fetch(`/api/course?id=${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + token }
            });

            if (res.ok) {
                // Remove element from DOM or reload
                loadProfile(); 
            } else {
                const text = await res.text();
                alert("Failed to delete: " + text);
            }
        } catch (e) {
            console.error(e);
            alert("Error deleting course");
        }
    }

    function logout() {
        localStorage.removeItem('token');
        window.location.href = 'login.html';
    }

    loadProfile();
</script>
</body>
</html>
